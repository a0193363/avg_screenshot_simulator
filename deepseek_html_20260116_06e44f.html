<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>游戏截图代餐制作器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #0f3460, #16213e);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #f8f9fa;
        }
        
        .header p {
            font-size: 0.9rem;
            color: #b8c1ec;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: 15px;
        }
        
        .preview-section {
            flex: 0 0 auto;
            background-color: #0f3460;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 比例 */
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .preview-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #previewCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .settings-section {
            flex: 1;
            background-color: #0f3460;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .steps-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: #16213e;
            border-radius: 8px;
            padding: 5px;
            flex-wrap: wrap;
        }
        
        .step-btn {
            flex: 1;
            min-width: 60px;
            padding: 10px 5px;
            text-align: center;
            background: transparent;
            border: none;
            color: #b8c1ec;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .step-btn i {
            font-size: 1.1rem;
        }
        
        .step-btn.active {
            background-color: #e94560;
            color: white;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }
        
        .step-btn:not(.active):hover {
            background-color: rgba(233, 69, 96, 0.2);
            color: #f8f9fa;
        }
        
        .step-content {
            flex: 1;
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .step-content.active {
            display: flex;
        }
        
        .step-title {
            font-size: 1.3rem;
            color: #f8f9fa;
            margin-bottom: 5px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e94560;
        }
        
        .upload-area {
            border: 2px dashed #b8c1ec;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(24, 33, 62, 0.5);
        }
        
        .upload-area:hover {
            border-color: #e94560;
            background-color: rgba(233, 69, 96, 0.1);
        }
        
        .upload-area i {
            font-size: 2.5rem;
            color: #b8c1ec;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            font-size: 0.95rem;
            color: #b8c1ec;
        }
        
        .control-group {
            background-color: #16213e;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control-label {
            font-size: 0.95rem;
            color: #f8f9fa;
        }
        
        .control-input {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #394867;
            background-color: #0f3460;
            color: #f8f9fa;
            font-size: 0.9rem;
            width: 60%;
        }
        
        .color-picker {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: transparent;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 60%;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #394867;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
        }
        
        .slider-value {
            font-size: 0.85rem;
            color: #b8c1ec;
            min-width: 30px;
        }
        
        .dialog-style-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .dialog-style {
            flex: 1;
            min-width: 80px;
            height: 50px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .dialog-style.selected {
            border-color: #e94560;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }
        
        .dialog-style-1 {
            background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.8) 50%);
        }
        
        .dialog-style-2 {
            background: linear-gradient(to bottom, rgba(40, 40, 80, 0) 0%, rgba(40, 40, 80, 0.9) 50%);
        }
        
        .dialog-style-3 {
            background: linear-gradient(to bottom, rgba(100, 20, 60, 0) 0%, rgba(100, 20, 60, 0.9) 50%);
        }
        
        .dialog-style-4 {
            background: linear-gradient(to bottom, rgba(20, 80, 100, 0) 0%, rgba(20, 80, 100, 0.9) 50%);
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #e94560;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #d1344e;
            box-shadow: 0 4px 12px rgba(233, 69, 96, 0.4);
        }
        
        .btn-secondary {
            background-color: #394867;
            color: #f8f9fa;
        }
        
        .btn-secondary:hover {
            background-color: #4a5a82;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .character-container {
            position: absolute;
            cursor: move;
            z-index: 10;
            border: 2px dashed rgba(233, 69, 96, 0.7);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .character-resize-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #e94560;
            border-radius: 50%;
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
        }
        
        .hidden {
            display: none;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin: 10px auto;
            border-radius: 6px;
            display: block;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                flex-direction: row;
                height: calc(100vh - 100px);
            }
            
            .preview-section {
                flex: 0 0 60%;
            }
            
            .settings-section {
                flex: 0 0 40%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-gamepad"></i> 游戏截图代餐制作器</h1>
        <p>为OC创作者设计的游戏截图风格图片制作工具</p>
    </div>
    
    <div class="container">
        <div class="preview-section">
            <div class="preview-container">
                <div class="preview-canvas-container">
                    <canvas id="previewCanvas"></canvas>
                </div>
                <div id="characterContainer" class="character-container hidden">
                    <img id="characterImage" src="" alt="角色图片">
                    <div class="character-resize-handle"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="steps-nav">
                <button class="step-btn active" data-step="1">
                    <i class="fas fa-user-circle"></i>
                    <span>角色</span>
                </button>
                <button class="step-btn" data-step="2">
                    <i class="fas fa-image"></i>
                    <span>背景</span>
                </button>
                <button class="step-btn" data-step="3">
                    <i class="fas fa-comment"></i>
                    <span>对话框</span>
                </button>
                <button class="step-btn" data-step="4">
                    <i class="fas fa-font"></i>
                    <span>角色名</span>
                </button>
                <button class="step-btn" data-step="5">
                    <i class="fas fa-quote-right"></i>
                    <span>台词</span>
                </button>
                <button class="step-btn" data-step="6">
                    <i class="fas fa-download"></i>
                    <span>导出</span>
                </button>
            </div>
            
            <!-- 步骤1：上传角色 -->
            <div class="step-content active" id="step-1">
                <h2 class="step-title">1. 上传角色图片</h2>
                <div class="upload-area" id="characterUpload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击或拖放上传角色图片 (PNG或JPG)</p>
                </div>
                <input type="file" id="characterFile" accept=".png,.jpg,.jpeg" class="hidden">
                
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">角色大小：</label>
                        <div class="slider-container">
                            <input type="range" min="20" max="150" value="80" class="slider" id="characterSize">
                            <span class="slider-value" id="characterSizeValue">80%</span>
                        </div>
                    </div>
                    <div class="control-row">
                        <label class="control-label">X轴位置：</label>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="50" class="slider" id="characterX">
                            <span class="slider-value" id="characterXValue">50%</span>
                        </div>
                    </div>
                    <div class="control-row">
                        <label class="control-label">Y轴位置：</label>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="50" class="slider" id="characterY">
                            <span class="slider-value" id="characterYValue">50%</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="resetCharacter">
                        <i class="fas fa-redo"></i> 重置位置
                    </button>
                </div>
            </div>
            
            <!-- 步骤2：背景设置 -->
            <div class="step-content" id="step-2">
                <h2 class="step-title">2. 背景设置</h2>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">背景类型：</label>
                        <select class="control-input" id="bgType">
                            <option value="color">纯色背景</option>
                            <option value="image">图片背景</option>
                        </select>
                    </div>
                    
                    <div id="bgColorContainer" class="control-row">
                        <label class="control-label">背景颜色：</label>
                        <input type="color" class="color-picker" id="bgColor" value="#ffffff">
                    </div>
                    
                    <div id="bgImageContainer" class="control-row hidden">
                        <label class="control-label">背景图片：</label>
                        <button class="btn btn-secondary" id="uploadBgBtn">
                            <i class="fas fa-upload"></i> 上传图片
                        </button>
                    </div>
                    <input type="file" id="bgFile" accept=".png,.jpg,.jpeg" class="hidden">
                    
                    <div id="bgPreviewContainer" class="hidden">
                        <img id="bgPreview" class="image-preview" src="" alt="背景预览">
                    </div>
                </div>
            </div>
            
            <!-- 步骤3：对话框设置 -->
            <div class="step-content" id="step-3">
                <h2 class="step-title">3. 对话框设置</h2>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">对话框样式：</label>
                        <div class="dialog-style-options">
                            <div class="dialog-style dialog-style-1 selected" data-style="1"></div>
                            <div class="dialog-style dialog-style-2" data-style="2"></div>
                            <div class="dialog-style dialog-style-3" data-style="3"></div>
                            <div class="dialog-style dialog-style-4" data-style="4"></div>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">对话框高度：</label>
                        <div class="slider-container">
                            <input type="range" min="20" max="50" value="33" class="slider" id="dialogHeight">
                            <span class="slider-value" id="dialogHeightValue">33%</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">显示对话框：</label>
                        <input type="checkbox" id="showDialog" checked style="width: 20px; height: 20px;">
                    </div>
                </div>
            </div>
            
            <!-- 步骤4：角色名设置 -->
            <div class="step-content" id="step-4">
                <h2 class="step-title">4. 角色名设置</h2>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">角色名：</label>
                        <input type="text" class="control-input" id="characterName" placeholder="输入角色名" value="主角名">
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">字体大小：</label>
                        <div class="slider-container">
                            <input type="range" min="6" max="24" value="8" class="slider" id="nameFontSize">
                            <span class="slider-value" id="nameFontSizeValue">8px</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">字体颜色：</label>
                        <input type="color" class="color-picker" id="nameColor" value="#ffffff">
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">X轴偏移：</label>
                        <div class="slider-container">
                            <input type="range" min="5" max="30" value="10" class="slider" id="nameX">
                            <span class="slider-value" id="nameXValue">10px</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">Y轴偏移：</label>
                        <div class="slider-container">
                            <input type="range" min="5" max="30" value="10" class="slider" id="nameY">
                            <span class="slider-value" id="nameYValue">10px</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 步骤5：台词设置 -->
            <div class="step-content" id="step-5">
                <h2 class="step-title">5. 台词设置</h2>
                <div class="control-group">
                    <div class="control-row">
                        <label class="control-label">台词内容：</label>
                        <textarea class="control-input" id="dialogueText" rows="4" placeholder="输入角色台词...">这是一段示例台词，可以在这里输入角色想说的话。</textarea>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">字体大小：</label>
                        <div class="slider-container">
                            <input type="range" min="4" max="16" value="5" class="slider" id="textFontSize">
                            <span class="slider-value" id="textFontSizeValue">5px</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">字体颜色：</label>
                        <input type="color" class="color-picker" id="textColor" value="#ffffff">
                    </div>
                    
                    <div class="control-row">
                        <label class="control-label">行高：</label>
                        <div class="slider-container">
                            <input type="range" min="1" max="2" step="0.1" value="1.2" class="slider" id="textLineHeight">
                            <span class="slider-value" id="textLineHeightValue">1.2</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 步骤6：导出图片 -->
            <div class="step-content" id="step-6">
                <h2 class="step-title">6. 导出图片</h2>
                <div class="control-group">
                    <p style="text-align: center; margin-bottom: 15px;">确认所有设置后，点击下方按钮导出最终图片。</p>
                    <p style="text-align: center; font-size: 0.9rem; color: #b8c1ec; margin-bottom: 20px;">
                        图片将按照以下图层顺序生成：<br>
                        <strong>对话文字 = 角色名 > 角色 > 背景</strong>
                    </p>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="exportBtn">
                            <i class="fas fa-download"></i> 导出图片 (PNG)
                        </button>
                        <button class="btn btn-secondary" id="previewExportBtn">
                            <i class="fas fa-eye"></i> 预览效果
                        </button>
                    </div>
                    
                    <div id="exportInfo" class="hidden" style="text-align: center; margin-top: 20px; padding: 10px; background-color: rgba(24, 33, 62, 0.7); border-radius: 8px;">
                        <p>图片已生成！点击下方链接下载：</p>
                        <a id="downloadLink" href="#" style="color: #e94560; font-weight: bold; word-break: break-all;">下载图片</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // DOM元素引用
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const characterContainer = document.getElementById('characterContainer');
        const characterImage = document.getElementById('characterImage');
        const stepButtons = document.querySelectorAll('.step-btn');
        const stepContents = document.querySelectorAll('.step-content');
        const characterUpload = document.getElementById('characterUpload');
        const characterFile = document.getElementById('characterFile');
        const characterSize = document.getElementById('characterSize');
        const characterSizeValue = document.getElementById('characterSizeValue');
        const characterX = document.getElementById('characterX');
        const characterXValue = document.getElementById('characterXValue');
        const characterY = document.getElementById('characterY');
        const characterYValue = document.getElementById('characterYValue');
        const resetCharacterBtn = document.getElementById('resetCharacter');
        const bgType = document.getElementById('bgType');
        const bgColor = document.getElementById('bgColor');
        const bgColorContainer = document.getElementById('bgColorContainer');
        const bgImageContainer = document.getElementById('bgImageContainer');
        const uploadBgBtn = document.getElementById('uploadBgBtn');
        const bgFile = document.getElementById('bgFile');
        const bgPreviewContainer = document.getElementById('bgPreviewContainer');
        const bgPreview = document.getElementById('bgPreview');
        const dialogStyles = document.querySelectorAll('.dialog-style');
        const dialogHeight = document.getElementById('dialogHeight');
        const dialogHeightValue = document.getElementById('dialogHeightValue');
        const showDialog = document.getElementById('showDialog');
        const characterName = document.getElementById('characterName');
        const nameFontSize = document.getElementById('nameFontSize');
        const nameFontSizeValue = document.getElementById('nameFontSizeValue');
        const nameColor = document.getElementById('nameColor');
        const nameX = document.getElementById('nameX');
        const nameXValue = document.getElementById('nameXValue');
        const nameY = document.getElementById('nameY');
        const nameYValue = document.getElementById('nameYValue');
        const dialogueText = document.getElementById('dialogueText');
        const textFontSize = document.getElementById('textFontSize');
        const textFontSizeValue = document.getElementById('textFontSizeValue');
        const textColor = document.getElementById('textColor');
        const textLineHeight = document.getElementById('textLineHeight');
        const textLineHeightValue = document.getElementById('textLineHeightValue');
        const exportBtn = document.getElementById('exportBtn');
        const previewExportBtn = document.getElementById('previewExportBtn');
        const exportInfo = document.getElementById('exportInfo');
        const downloadLink = document.getElementById('downloadLink');
        
        // 应用状态
        let appState = {
            character: {
                image: null,
                width: 0,
                height: 0,
                x: 50,
                y: 50,
                size: 80
            },
            background: {
                type: 'color',
                color: '#ffffff',
                image: null
            },
            dialog: {
                style: 1,
                height: 33,
                visible: true
            },
            name: {
                text: '主角名',
                fontSize: 8,
                color: '#ffffff',
                x: 10,
                y: 10
            },
            dialogue: {
                text: '这是一段示例台词，可以在这里输入角色想说的话。',
                fontSize: 5,
                color: '#ffffff',
                lineHeight: 1.2
            }
        };
        
        // 初始化
        function init() {
            // 设置画布尺寸
            updateCanvasSize();
            window.addEventListener('resize', updateCanvasSize);
            
            // 设置步骤导航
            stepButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const step = button.getAttribute('data-step');
                    showStep(step);
                });
            });
            
            // 角色上传
            characterUpload.addEventListener('click', () => characterFile.click());
            characterUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                characterUpload.style.borderColor = '#e94560';
                characterUpload.style.backgroundColor = 'rgba(233, 69, 96, 0.1)';
            });
            characterUpload.addEventListener('dragleave', () => {
                characterUpload.style.borderColor = '#b8c1ec';
                characterUpload.style.backgroundColor = 'rgba(24, 33, 62, 0.5)';
            });
            characterUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                characterUpload.style.borderColor = '#b8c1ec';
                characterUpload.style.backgroundColor = 'rgba(24, 33, 62, 0.5)';
                
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.match('image.*')) {
                        loadCharacterImage(file);
                    }
                }
            });
            characterFile.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    loadCharacterImage(e.target.files[0]);
                }
            });
            
            // 角色控制
            characterSize.addEventListener('input', updateCharacterSize);
            characterX.addEventListener('input', updateCharacterPosition);
            characterY.addEventListener('input', updateCharacterPosition);
            resetCharacterBtn.addEventListener('click', resetCharacterPosition);
            
            // 背景控制
            bgType.addEventListener('change', updateBackgroundType);
            bgColor.addEventListener('input', updateBackgroundColor);
            uploadBgBtn.addEventListener('click', () => bgFile.click());
            bgFile.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    loadBackgroundImage(e.target.files[0]);
                }
            });
            
            // 对话框控制
            dialogStyles.forEach(style => {
                style.addEventListener('click', () => {
                    dialogStyles.forEach(s => s.classList.remove('selected'));
                    style.classList.add('selected');
                    appState.dialog.style = parseInt(style.getAttribute('data-style'));
                    renderPreview();
                });
            });
            dialogHeight.addEventListener('input', updateDialogHeight);
            showDialog.addEventListener('change', updateDialogVisibility);
            
            // 角色名控制
            characterName.addEventListener('input', updateCharacterName);
            nameFontSize.addEventListener('input', updateNameFontSize);
            nameColor.addEventListener('input', updateNameColor);
            nameX.addEventListener('input', updateNamePosition);
            nameY.addEventListener('input', updateNamePosition);
            
            // 台词控制
            dialogueText.addEventListener('input', updateDialogueText);
            textFontSize.addEventListener('input', updateTextFontSize);
            textColor.addEventListener('input', updateTextColor);
            textLineHeight.addEventListener('input', updateTextLineHeight);
            
            // 导出控制
            exportBtn.addEventListener('click', exportImage);
            previewExportBtn.addEventListener('click', renderPreview);
            
            // 初始化渲染
            renderPreview();
            
            // 初始化角色拖拽
            initCharacterDragging();
            
            // 显示默认步骤
            showStep(1);
        }
        
        // 更新画布尺寸
        function updateCanvasSize() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            renderPreview();
        }
        
        // 显示步骤
        function showStep(step) {
            // 更新按钮状态
            stepButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-step') === step) {
                    button.classList.add('active');
                }
            });
            
            // 更新内容显示
            stepContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `step-${step}`) {
                    content.classList.add('active');
                }
            });
            
            // 如果是第一步，确保角色容器可见
            if (step === '1' && appState.character.image) {
                characterContainer.classList.remove('hidden');
            }
        }
        
        // 加载角色图片
        function loadCharacterImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    appState.character.image = img;
                    appState.character.width = img.width;
                    appState.character.height = img.height;
                    
                    // 显示角色容器并设置初始位置
                    characterContainer.classList.remove('hidden');
                    characterImage.src = e.target.result;
                    
                    // 设置角色容器初始位置和大小
                    updateCharacterContainer();
                    
                    renderPreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 更新角色容器位置和大小
        function updateCharacterContainer() {
            if (!appState.character.image) return;
            
            const container = characterContainer.parentElement;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // 计算角色显示尺寸
            const sizePercent = appState.character.size / 100;
            const displayWidth = containerWidth * sizePercent;
            const displayHeight = (appState.character.height / appState.character.width) * displayWidth;
            
            // 计算角色位置
            const xPercent = appState.character.x / 100;
            const yPercent = appState.character.y / 100;
            const posX = (containerWidth - displayWidth) * xPercent;
            const posY = (containerHeight - displayHeight) * yPercent;
            
            // 应用样式
            characterContainer.style.width = `${displayWidth}px`;
            characterContainer.style.height = `${displayHeight}px`;
            characterContainer.style.left = `${posX}px`;
            characterContainer.style.top = `${posY}px`;
            
            // 更新滑块显示
            characterSizeValue.textContent = `${appState.character.size}%`;
            characterXValue.textContent = `${appState.character.x}%`;
            characterYValue.textContent = `${appState.character.y}%`;
        }
        
        // 更新角色大小
        function updateCharacterSize() {
            appState.character.size = parseInt(characterSize.value);
            characterSizeValue.textContent = `${appState.character.size}%`;
            updateCharacterContainer();
            renderPreview();
        }
        
        // 更新角色位置
        function updateCharacterPosition() {
            appState.character.x = parseInt(characterX.value);
            appState.character.y = parseInt(characterY.value);
            characterXValue.textContent = `${appState.character.x}%`;
            characterYValue.textContent = `${appState.character.y}%`;
            updateCharacterContainer();
            renderPreview();
        }
        
        // 重置角色位置
        function resetCharacterPosition() {
            appState.character.x = 50;
            appState.character.y = 50;
            appState.character.size = 80;
            
            characterSize.value = 80;
            characterX.value = 50;
            characterY.value = 50;
            
            updateCharacterSize();
            updateCharacterPosition();
        }
        
        // 初始化角色拖拽
        function initCharacterDragging() {
            let isDragging = false;
            let isResizing = false;
            let startX, startY;
            let startWidth, startHeight;
            let startLeft, startTop;
            
            characterContainer.addEventListener('mousedown', startDrag);
            characterContainer.addEventListener('touchstart', startDragTouch);
            
            const resizeHandle = document.querySelector('.character-resize-handle');
            resizeHandle.addEventListener('mousedown', startResize);
            resizeHandle.addEventListener('touchstart', startResizeTouch);
            
            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                const rect = characterContainer.getBoundingClientRect();
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                
                if (e.type === 'mousedown') {
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;
                    document.addEventListener('mousemove', drag);
                    document.addEventListener('mouseup', stopDrag);
                }
            }
            
            function startDragTouch(e) {
                e.preventDefault();
                isDragging = true;
                const touch = e.touches[0];
                const rect = characterContainer.getBoundingClientRect();
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                
                startX = touch.clientX - rect.left;
                startY = touch.clientY - rect.top;
                document.addEventListener('touchmove', dragTouch);
                document.addEventListener('touchend', stopDragTouch);
            }
            
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                const newX = e.clientX - startX - parentRect.left;
                const newY = e.clientY - startY - parentRect.top;
                
                // 限制在父容器内
                const maxX = parentRect.width - characterContainer.clientWidth;
                const maxY = parentRect.height - characterContainer.clientHeight;
                
                const clampedX = Math.max(0, Math.min(newX, maxX));
                const clampedY = Math.max(0, Math.min(newY, maxY));
                
                characterContainer.style.left = `${clampedX}px`;
                characterContainer.style.top = `${clampedY}px`;
                
                // 更新状态
                appState.character.x = (clampedX / maxX) * 100;
                appState.character.y = (clampedY / maxY) * 100;
                
                characterX.value = appState.character.x;
                characterY.value = appState.character.y;
                characterXValue.textContent = `${Math.round(appState.character.x)}%`;
                characterYValue.textContent = `${Math.round(appState.character.y)}%`;
                
                renderPreview();
            }
            
            function dragTouch(e) {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches[0];
                
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                const newX = touch.clientX - startX - parentRect.left;
                const newY = touch.clientY - startY - parentRect.top;
                
                // 限制在父容器内
                const maxX = parentRect.width - characterContainer.clientWidth;
                const maxY = parentRect.height - characterContainer.clientHeight;
                
                const clampedX = Math.max(0, Math.min(newX, maxX));
                const clampedY = Math.max(0, Math.min(newY, maxY));
                
                characterContainer.style.left = `${clampedX}px`;
                characterContainer.style.top = `${clampedY}px`;
                
                // 更新状态
                appState.character.x = (clampedX / maxX) * 100;
                appState.character.y = (clampedY / maxY) * 100;
                
                characterX.value = appState.character.x;
                characterY.value = appState.character.y;
                characterXValue.textContent = `${Math.round(appState.character.x)}%`;
                characterYValue.textContent = `${Math.round(appState.character.y)}%`;
                
                renderPreview();
            }
            
            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
            }
            
            function stopDragTouch() {
                isDragging = false;
                document.removeEventListener('touchmove', dragTouch);
                document.removeEventListener('touchend', stopDragTouch);
            }
            
            function startResize(e) {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                
                startWidth = parseInt(getComputedStyle(characterContainer).width);
                startHeight = parseInt(getComputedStyle(characterContainer).height);
                startLeft = parseInt(getComputedStyle(characterContainer).left);
                startTop = parseInt(getComputedStyle(characterContainer).top);
                
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                }
            }
            
            function startResizeTouch(e) {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                const touch = e.touches[0];
                
                startWidth = parseInt(getComputedStyle(characterContainer).width);
                startHeight = parseInt(getComputedStyle(characterContainer).height);
                startLeft = parseInt(getComputedStyle(characterContainer).left);
                startTop = parseInt(getComputedStyle(characterContainer).top);
                
                startX = touch.clientX;
                startY = touch.clientY;
                document.addEventListener('touchmove', resizeTouch);
                document.addEventListener('touchend', stopResizeTouch);
            }
            
            function resize(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                // 计算新尺寸
                const newWidth = Math.max(50, Math.min(startWidth + deltaX, parentRect.width - startLeft));
                const newHeight = (appState.character.height / appState.character.width) * newWidth;
                
                // 应用新尺寸
                characterContainer.style.width = `${newWidth}px`;
                characterContainer.style.height = `${newHeight}px`;
                
                // 更新状态
                const sizePercent = (newWidth / parentRect.width) * 100;
                appState.character.size = sizePercent;
                
                characterSize.value = sizePercent;
                characterSizeValue.textContent = `${Math.round(sizePercent)}%`;
                
                renderPreview();
            }
            
            function resizeTouch(e) {
                if (!isResizing) return;
                e.preventDefault();
                const touch = e.touches[0];
                
                const parentRect = characterContainer.parentElement.getBoundingClientRect();
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;
                
                // 计算新尺寸
                const newWidth = Math.max(50, Math.min(startWidth + deltaX, parentRect.width - startLeft));
                const newHeight = (appState.character.height / appState.character.width) * newWidth;
                
                // 应用新尺寸
                characterContainer.style.width = `${newWidth}px`;
                characterContainer.style.height = `${newHeight}px`;
                
                // 更新状态
                const sizePercent = (newWidth / parentRect.width) * 100;
                appState.character.size = sizePercent;
                
                characterSize.value = sizePercent;
                characterSizeValue.textContent = `${Math.round(sizePercent)}%`;
                
                renderPreview();
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
            
            function stopResizeTouch() {
                isResizing = false;
                document.removeEventListener('touchmove', resizeTouch);
                document.removeEventListener('touchend', stopResizeTouch);
            }
        }
        
        // 更新背景类型
        function updateBackgroundType() {
            appState.background.type = bgType.value;
            
            if (appState.background.type === 'color') {
                bgColorContainer.classList.remove('hidden');
                bgImageContainer.classList.add('hidden');
                bgPreviewContainer.classList.add('hidden');
            } else {
                bgColorContainer.classList.add('hidden');
                bgImageContainer.classList.remove('hidden');
                if (appState.background.image) {
                    bgPreviewContainer.classList.remove('hidden');
                }
            }
            
            renderPreview();
        }
        
        // 更新背景颜色
        function updateBackgroundColor() {
            appState.background.color = bgColor.value;
            renderPreview();
        }
        
        // 加载背景图片
        function loadBackgroundImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    appState.background.image = img;
                    bgPreview.src = e.target.result;
                    bgPreviewContainer.classList.remove('hidden');
                    renderPreview();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // 更新对话框高度
        function updateDialogHeight() {
            appState.dialog.height = parseInt(dialogHeight.value);
            dialogHeightValue.textContent = `${appState.dialog.height}%`;
            renderPreview();
        }
        
        // 更新对话框可见性
        function updateDialogVisibility() {
            appState.dialog.visible = showDialog.checked;
            renderPreview();
        }
        
        // 更新角色名
        function updateCharacterName() {
            appState.name.text = characterName.value;
            renderPreview();
        }
        
        // 更新名字字体大小
        function updateNameFontSize() {
            appState.name.fontSize = parseInt(nameFontSize.value);
            nameFontSizeValue.textContent = `${appState.name.fontSize}px`;
            renderPreview();
        }
        
        // 更新名字颜色
        function updateNameColor() {
            appState.name.color = nameColor.value;
            renderPreview();
        }
        
        // 更新名字位置
        function updateNamePosition() {
            appState.name.x = parseInt(nameX.value);
            appState.name.y = parseInt(nameY.value);
            nameXValue.textContent = `${appState.name.x}px`;
            nameYValue.textContent = `${appState.name.y}px`;
            renderPreview();
        }
        
        // 更新台词文本
        function updateDialogueText() {
            appState.dialogue.text = dialogueText.value;
            renderPreview();
        }
        
        // 更新文本字体大小
        function updateTextFontSize() {
            appState.dialogue.fontSize = parseInt(textFontSize.value);
            textFontSizeValue.textContent = `${appState.dialogue.fontSize}px`;
            renderPreview();
        }
        
        // 更新文本颜色
        function updateTextColor() {
            appState.dialogue.color = textColor.value;
            renderPreview();
        }
        
        // 更新文本行高
        function updateTextLineHeight() {
            appState.dialogue.lineHeight = parseFloat(textLineHeight.value);
            textLineHeightValue.textContent = appState.dialogue.lineHeight.toFixed(1);
            renderPreview();
        }
        
        // 渲染预览
        function renderPreview() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            if (appState.background.type === 'color') {
                ctx.fillStyle = appState.background.color;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (appState.background.type === 'image' && appState.background.image) {
                // 计算图片缩放以适应画布并保持16:9比例
                const img = appState.background.image;
                const canvasRatio = canvas.width / canvas.height;
                const imgRatio = img.width / img.height;
                
                let drawWidth, drawHeight, offsetX, offsetY;
                
                if (imgRatio > canvasRatio) {
                    // 图片更宽，以高度为准
                    drawHeight = canvas.height;
                    drawWidth = img.width * (canvas.height / img.height);
                    offsetX = (canvas.width - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    // 图片更高，以宽度为准
                    drawWidth = canvas.width;
                    drawHeight = img.height * (canvas.width / img.width);
                    offsetX = 0;
                    offsetY = (canvas.height - drawHeight) / 2;
                }
                
                ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
            }
            
            // 绘制角色
            if (appState.character.image) {
                const sizePercent = appState.character.size / 100;
                const displayWidth = canvas.width * sizePercent;
                const displayHeight = (appState.character.height / appState.character.width) * displayWidth;
                
                const xPercent = appState.character.x / 100;
                const yPercent = appState.character.y / 100;
                const posX = (canvas.width - displayWidth) * xPercent;
                const posY = (canvas.height - displayHeight) * yPercent;
                
                ctx.drawImage(appState.character.image, posX, posY, displayWidth, displayHeight);
            }
            
            // 绘制对话框
            if (appState.dialog.visible) {
                const dialogTop = canvas.height * (1 - appState.dialog.height / 100);
                
                // 根据选择的样式设置渐变
                let gradient;
                switch (appState.dialog.style) {
                    case 1:
                        gradient = ctx.createLinearGradient(0, dialogTop, 0, canvas.height);
                        gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
                        gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.8)');
                        gradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
                        break;
                    case 2:
                        gradient = ctx.createLinearGradient(0, dialogTop, 0, canvas.height);
                        gradient.addColorStop(0, 'rgba(40, 40, 80, 0)');
                        gradient.addColorStop(0.5, 'rgba(40, 40, 80, 0.9)');
                        gradient.addColorStop(1, 'rgba(40, 40, 80, 0.9)');
                        break;
                    case 3:
                        gradient = ctx.createLinearGradient(0, dialogTop, 0, canvas.height);
                        gradient.addColorStop(0, 'rgba(100, 20, 60, 0)');
                        gradient.addColorStop(0.5, 'rgba(100, 20, 60, 0.9)');
                        gradient.addColorStop(1, 'rgba(100, 20, 60, 0.9)');
                        break;
                    case 4:
                        gradient = ctx.createLinearGradient(0, dialogTop, 0, canvas.height);
                        gradient.addColorStop(0, 'rgba(20, 80, 100, 0)');
                        gradient.addColorStop(0.5, 'rgba(20, 80, 100, 0.9)');
                        gradient.addColorStop(1, 'rgba(20, 80, 100, 0.9)');
                        break;
                }
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, dialogTop, canvas.width, canvas.height - dialogTop);
            }
            
            // 绘制角色名
            if (appState.name.text && appState.dialog.visible) {
                const dialogTop = canvas.height * (1 - appState.dialog.height / 100);
                
                ctx.font = `${appState.name.fontSize}px Arial, sans-serif`;
                ctx.fillStyle = appState.name.color;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText(appState.name.text, appState.name.x, dialogTop + appState.name.y);
            }
            
            // 绘制台词
            if (appState.dialogue.text && appState.dialog.visible) {
                const dialogTop = canvas.height * (1 - appState.dialog.height / 100);
                const textX = appState.name.x + 30;
                const textY = dialogTop + appState.name.y + appState.name.fontSize + 5;
                const maxWidth = canvas.width - textX - 20;
                
                ctx.font = `${appState.dialogue.fontSize}px Arial, sans-serif`;
                ctx.fillStyle = appState.dialogue.color;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                
                // 文本换行
                const words = appState.dialogue.text.split(' ');
                let line = '';
                let lineHeight = appState.dialogue.fontSize * appState.dialogue.lineHeight;
                let y = textY;
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;
                    
                    if (testWidth > maxWidth && i > 0) {
                        ctx.fillText(line, textX, y);
                        line = words[i] + ' ';
                        y += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, textX, y);
            }
        }
        
        // 导出图片
        function exportImage() {
            // 创建临时canvas用于导出
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            
            // 设置导出尺寸（保持16:9比例）
            const exportWidth = 1280;
            const exportHeight = 720;
            
            exportCanvas.width = exportWidth;
            exportCanvas.height = exportHeight;
            
            // 绘制背景
            if (appState.background.type === 'color') {
                exportCtx.fillStyle = appState.background.color;
                exportCtx.fillRect(0, 0, exportWidth, exportHeight);
            } else if (appState.background.type === 'image' && appState.background.image) {
                // 计算图片缩放以适应画布并保持16:9比例
                const img = appState.background.image;
                const canvasRatio = exportWidth / exportHeight;
                const imgRatio = img.width / img.height;
                
                let drawWidth, drawHeight, offsetX, offsetY;
                
                if (imgRatio > canvasRatio) {
                    // 图片更宽，以高度为准
                    drawHeight = exportHeight;
                    drawWidth = img.width * (exportHeight / img.height);
                    offsetX = (exportWidth - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    // 图片更高，以宽度为准
                    drawWidth = exportWidth;
                    drawHeight = img.height * (exportWidth / img.width);
                    offsetX = 0;
                    offsetY = (exportHeight - drawHeight) / 2;
                }
                
                exportCtx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
            }
            
            // 绘制角色
            if (appState.character.image) {
                const sizePercent = appState.character.size / 100;
                const displayWidth = exportWidth * sizePercent;
                const displayHeight = (appState.character.height / appState.character.width) * displayWidth;
                
                const xPercent = appState.character.x / 100;
                const yPercent = appState.character.y / 100;
                const posX = (exportWidth - displayWidth) * xPercent;
                const posY = (exportHeight - displayHeight) * yPercent;
                
                exportCtx.drawImage(appState.character.image, posX, posY, displayWidth, displayHeight);
            }
            
            // 绘制对话框
            if (appState.dialog.visible) {
                const dialogTop = exportHeight * (1 - appState.dialog.height / 100);
                
                // 根据选择的样式设置渐变
                let gradient;
                switch (appState.dialog.style) {
                    case 1:
                        gradient = exportCtx.createLinearGradient(0, dialogTop, 0, exportHeight);
                        gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
                        gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.8)');
                        gradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
                        break;
                    case 2:
                        gradient = exportCtx.createLinearGradient(0, dialogTop, 0, exportHeight);
                        gradient.addColorStop(0, 'rgba(40, 40, 80, 0)');
                        gradient.addColorStop(0.5, 'rgba(40, 40, 80, 0.9)');
                        gradient.addColorStop(1, 'rgba(40, 40, 80, 0.9)');
                        break;
                    case 3:
                        gradient = exportCtx.createLinearGradient(0, dialogTop, 0, exportHeight);
                        gradient.addColorStop(0, 'rgba(100, 20, 60, 0)');
                        gradient.addColorStop(0.5, 'rgba(100, 20, 60, 0.9)');
                        gradient.addColorStop(1, 'rgba(100, 20, 60, 0.9)');
                        break;
                    case 4:
                        gradient = exportCtx.createLinearGradient(0, dialogTop, 0, exportHeight);
                        gradient.addColorStop(0, 'rgba(20, 80, 100, 0)');
                        gradient.addColorStop(0.5, 'rgba(20, 80, 100, 0.9)');
                        gradient.addColorStop(1, 'rgba(20, 80, 100, 0.9)');
                        break;
                }
                
                exportCtx.fillStyle = gradient;
                exportCtx.fillRect(0, dialogTop, exportWidth, exportHeight - dialogTop);
            }
            
            // 绘制角色名
            if (appState.name.text && appState.dialog.visible) {
                const dialogTop = exportHeight * (1 - appState.dialog.height / 100);
                const scaleFactor = exportWidth / canvas.width;
                
                exportCtx.font = `${appState.name.fontSize * scaleFactor}px Arial, sans-serif`;
                exportCtx.fillStyle = appState.name.color;
                exportCtx.textAlign = 'left';
                exportCtx.textBaseline = 'top';
                exportCtx.fillText(appState.name.text, appState.name.x * scaleFactor, dialogTop + appState.name.y * scaleFactor);
            }
            
            // 绘制台词
            if (appState.dialogue.text && appState.dialog.visible) {
                const dialogTop = exportHeight * (1 - appState.dialog.height / 100);
                const scaleFactor = exportWidth / canvas.width;
                
                const textX = (appState.name.x + 30) * scaleFactor;
                const textY = dialogTop + (appState.name.y + appState.name.fontSize + 5) * scaleFactor;
                const maxWidth = exportWidth - textX - 20 * scaleFactor;
                
                exportCtx.font = `${appState.dialogue.fontSize * scaleFactor}px Arial, sans-serif`;
                exportCtx.fillStyle = appState.dialogue.color;
                exportCtx.textAlign = 'left';
                exportCtx.textBaseline = 'top';
                
                // 文本换行
                const words = appState.dialogue.text.split(' ');
                let line = '';
                let lineHeight = appState.dialogue.fontSize * scaleFactor * appState.dialogue.lineHeight;
                let y = textY;
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = exportCtx.measureText(testLine);
                    const testWidth = metrics.width;
                    
                    if (testWidth > maxWidth && i > 0) {
                        exportCtx.fillText(line, textX, y);
                        line = words[i] + ' ';
                        y += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                exportCtx.fillText(line, textX, y);
            }
            
            // 生成下载链接
            const dataURL = exportCanvas.toDataURL('image/png');
            downloadLink.href = dataURL;
            downloadLink.download = `游戏截图代餐_${new Date().getTime()}.png`;
            
            // 显示下载信息
            exportInfo.classList.remove('hidden');
            
            // 滚动到导出部分
            showStep(6);
        }
        
        // 初始化应用
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>